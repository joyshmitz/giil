{"id":"get_icloud_image_link-hdm","title":"EPIC: giil v3.0 Multi-Platform Expansion","description":"## Overview\n\nTransform giil from an iCloud-only tool into a universal cloud image downloader supporting Dropbox, Google Photos, and Google Drive (experimental).\n\n## Strategic Context\n\ngiil (\"Get Image [from] Internet Link\", originally \"Get iCloud Image Link\") serves a critical workflow: enabling AI coding assistants to view images shared from mobile devices during remote SSH sessions. Expanding platform support multiplies the tool's utility without changing its core value proposition.\n\n## Key Insights from Research (Jan 2026)\n\n1. **Dropbox is trivial**: Simple URL parameter change (dl=0 → raw=1) enables direct curl downloads. No browser needed. 1-3s vs 5-15s.\n\n2. **Google Photos is solvable**: CDN URLs have size modifiers. The =s0 suffix returns original resolution. Browser needed only for URL extraction, not download.\n\n3. **Google Drive is conditional**: 2024 API changes broke direct URLs. Requires \"Anyone with the link\" sharing. Ship as experimental.\n\n## Implementation Phases\n\n1. **Core Infrastructure** - Platform detection, adapter interface, content validation\n2. **Dropbox Support** - Direct URL downloads, no Playwright needed\n3. **Google Photos Support** - CDN URL extraction + =s0 modifier\n4. **Google Drive (Experimental)** - Multi-tier with auth detection\n5. **Output \u0026 Error Handling** - New exit codes, JSON schema\n6. **Testing Infrastructure** - Unit, replay, and live tests\n7. **Documentation \u0026 Release** - README rewrite, v3.0.0 release\n\n## Success Criteria\n\n- All existing iCloud commands work unchanged (backward compatibility)\n- Dropbox links download at full resolution without Playwright\n- Google Photos links download at full resolution with =s0 modifier\n- Google Drive links work for properly shared files (with clear errors for restricted files)\n- New JSON schema with schema_version, ok, platform fields\n- Extended exit codes for better scripting (0-20)\n- Comprehensive documentation for all platforms\n\n## Non-Goals (Critical Boundaries)\n\n- No bypassing authentication or CAPTCHAs\n- No credential storage or harvesting\n- No \"bulk scraping\" positioning\n- No silent quality degradation\n\n## Version Target: v3.0.0\n\nMajor version bump due to:\n- New default behavior (preserve original bytes vs MozJPEG compression)\n- JSON schema additions (breaking for strict parsers)\n- Extended exit codes\n","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-03T22:17:32.897877999-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:18:05.464107184-05:00"}
{"id":"get_icloud_image_link-hdm.1","title":"EPIC: Phase 1 - Core Infrastructure","description":"## Purpose\n\nBuild the foundational components that all platform adapters will depend on. This phase establishes patterns and utilities that ensure consistency across platforms.\n\n## Why This Matters\n\nWithout a solid foundation, each platform implementation becomes a one-off with duplicated logic. The Platform Adapter interface ensures:\n- Consistent URL detection and normalization\n- Shared content validation (prevent HTML-as-image bugs)\n- Unified error handling and exit codes\n- Testable, modular architecture\n\n## Key Components\n\n1. **Platform Detection** - Regex-based URL pattern matching in both bash and JS\n2. **Content Validation** - MIME type checking, magic bytes verification\n3. **Exit Code Framework** - Extended codes 10-13, 20 for scripting\n4. **Adapter Interface** - TypeScript/JSDoc interface definition\n\n## Design Decision: Dual Implementation\n\nPlatform detection must exist in BOTH bash and JavaScript layers:\n- **Bash**: Decides whether to skip Playwright entirely (Dropbox fast path)\n- **JavaScript**: Used within extractor for platform-specific capture strategies\n\nThe implementations must stay synchronized. Consider extracting to a shared format (JSON config) that both layers read.\n\n## Acceptance Criteria\n\n- [ ] detect_platform() works in bash for all 4 platforms\n- [ ] detectPlatform() works in JS for all 4 platforms\n- [ ] Content-Type validation rejects HTML with image extensions\n- [ ] Magic bytes validation detects JPEG/PNG/HEIC/WebP\n- [ ] All new exit codes are documented and used consistently\n","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-03T22:18:22.224145189-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:58:46.695470715-05:00","closed_at":"2026-01-03T22:58:46.695470715-05:00","close_reason":"All Phase 1 Core Infrastructure tasks complete: content validation, platform detection, exit codes, rate limiting, and adapter interface","dependencies":[{"issue_id":"get_icloud_image_link-hdm.1","depends_on_id":"get_icloud_image_link-hdm","type":"parent-child","created_at":"2026-01-03T22:18:22.253058212-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.1.1","title":"Implement detect_platform() in bash","description":"## What\n\nAdd a detect_platform() function to the giil bash script that identifies which cloud service a URL belongs to.\n\n## Implementation\n\n```bash\ndetect_platform() {\n    local url=\"$1\"\n    case \"$url\" in\n        *share.icloud.com/photos/* | *icloud.com/photos/*)\n            echo \"icloud\" ;;\n        *dropbox.com/s/* | *dropbox.com/scl/fi/* | *dropbox.com/sh/*)\n            echo \"dropbox\" ;;\n        *photos.app.goo.gl/* | *photos.google.com/share/*)\n            echo \"gphotos\" ;;\n        *drive.google.com/file/d/* | *drive.google.com/open?id=*)\n            echo \"gdrive\" ;;\n        *)\n            echo \"unknown\" ;;\n    esac\n}\n```\n\n## Why Case Patterns\n\nCase statements are faster than regex in bash and more readable. The patterns cover:\n- **iCloud**: Both share.icloud.com and www.icloud.com formats\n- **Dropbox**: /s/ (legacy), /scl/fi/ (new), /sh/ (folders)\n- **Google Photos**: Short links (goo.gl) and full links\n- **Google Drive**: /file/d/ and /open?id= formats\n\n## Testing\n\n```bash\n# Should output: icloud\ndetect_platform \"https://share.icloud.com/photos/abc123\"\n\n# Should output: dropbox\ndetect_platform \"https://www.dropbox.com/scl/fi/xyz/photo.png?dl=0\"\n\n# Should output: gphotos\ndetect_platform \"https://photos.app.goo.gl/abc123\"\n\n# Should output: gdrive\ndetect_platform \"https://drive.google.com/file/d/xyz/view\"\n\n# Should output: unknown\ndetect_platform \"https://example.com/photo.jpg\"\n```\n\n## Location in Script\n\nAdd near the URL normalization functions, around line 1400 in giil.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:18:39.642247434-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:51:27.746378546-05:00","closed_at":"2026-01-03T22:51:27.746378546-05:00","close_reason":"Implemented detect_platform() with URL pattern matching for icloud/dropbox/gphotos/gdrive/unknown. Validated with ShellCheck and unit tests.","dependencies":[{"issue_id":"get_icloud_image_link-hdm.1.1","depends_on_id":"get_icloud_image_link-hdm.1","type":"parent-child","created_at":"2026-01-03T22:18:39.670607957-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.1.2","title":"Implement detectPlatform() in JavaScript extractor","description":"## What\n\nAdd a detectPlatform() function to extractor.mjs that mirrors the bash implementation.\n\n## Implementation\n\n```javascript\nfunction detectPlatform(url) {\n    const patterns = {\n        icloud: /(?:share\\.)?icloud\\.com\\/photos/i,\n        dropbox: /dropbox\\.com\\/(?:s|scl\\/fi|sh)\\//i,\n        gphotos: /photos\\.(?:app\\.goo\\.gl|google\\.com\\/share)/i,\n        gdrive: /(?:drive|docs)\\.google\\.com\\/(?:file\\/d|open\\?id)/i\n    };\n\n    for (const [platform, regex] of Object.entries(patterns)) {\n        if (regex.test(url)) return platform;\n    }\n    return 'unknown';\n}\n```\n\n## Why Regex in JS\n\nUnlike bash where case patterns are idiomatic, JavaScript regex is:\n- More expressive (non-capturing groups, case insensitivity)\n- Easier to test in isolation\n- Standard practice in the JS ecosystem\n\n## Sync Requirement\n\nThis MUST return the same results as the bash detect_platform(). Consider:\n1. A shared test suite that runs both implementations\n2. A JSON config file both read (future enhancement)\n3. CI job that verifies parity\n\n## Usage in Extractor\n\n```javascript\nconst platform = detectPlatform(url);\nswitch (platform) {\n    case 'icloud':\n        return await captureICloud(page, url);\n    case 'dropbox':\n        return await captureDropbox(page, url);\n    case 'gphotos':\n        return await captureGooglePhotos(page, url);\n    case 'gdrive':\n        return await captureGoogleDrive(page, url);\n    default:\n        throw new Error(`Unsupported platform: ${url}`);\n}\n```\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:18:54.787407649-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:58:02.807878979-05:00","closed_at":"2026-01-03T22:58:02.807878979-05:00","close_reason":"Already implemented - detectPlatform() function with regex patterns for icloud/dropbox/gphotos/gdrive detection.","dependencies":[{"issue_id":"get_icloud_image_link-hdm.1.2","depends_on_id":"get_icloud_image_link-hdm.1","type":"parent-child","created_at":"2026-01-03T22:18:54.816461397-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.1.2","depends_on_id":"get_icloud_image_link-hdm.1.1","type":"blocks","created_at":"2026-01-03T22:27:34.204570526-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.1.3","title":"Implement content validation (MIME + magic bytes)","description":"## What\n\nAdd validation to ensure downloaded content is actually an image, not an HTML error page.\n\n## Why This Is Critical\n\nDropbox and Google Drive can return HTML error pages with HTTP 200:\n- Password-protected links return HTML login form\n- Expired links return HTML error page\n- Private files return HTML \"request access\" page\n\nWithout validation, giil would save HTML as \"image.jpg\" - a silent, confusing failure.\n\n## Implementation: Two-Layer Validation\n\n### Layer 1: Content-Type Header\n\n```javascript\nfunction validateContentType(response) {\n    const contentType = response.headers()['content-type'] || '';\n    const validTypes = [\n        'image/jpeg', 'image/png', 'image/gif', \n        'image/webp', 'image/heic', 'image/heif',\n        'application/octet-stream'  // Some CDNs use this\n    ];\n    \n    // Reject HTML explicitly\n    if (contentType.includes('text/html')) {\n        throw new Error('CONTENT_TYPE_HTML: Server returned HTML, not image');\n    }\n    \n    // Warn if unexpected but allow (some CDNs misconfigure)\n    const isValid = validTypes.some(t =\u003e contentType.includes(t));\n    return { valid: isValid, contentType };\n}\n```\n\n### Layer 2: Magic Bytes Verification\n\n```javascript\nconst MAGIC_BYTES = {\n    jpeg: [0xFF, 0xD8, 0xFF],\n    png: [0x89, 0x50, 0x4E, 0x47],\n    gif: [0x47, 0x49, 0x46, 0x38],\n    webp: [0x52, 0x49, 0x46, 0x46],  // \"RIFF\" (check for WEBP at offset 8)\n    heic: [0x00, 0x00, 0x00],  // ftyp box (check for heic/mif1 later)\n};\n\nfunction validateMagicBytes(buffer) {\n    const head = buffer.slice(0, 12);\n    \n    // Check JPEG\n    if (head[0] === 0xFF \u0026\u0026 head[1] === 0xD8 \u0026\u0026 head[2] === 0xFF) {\n        return 'jpeg';\n    }\n    \n    // Check PNG\n    if (head[0] === 0x89 \u0026\u0026 head[1] === 0x50 \u0026\u0026 head[2] === 0x4E \u0026\u0026 head[3] === 0x47) {\n        return 'png';\n    }\n    \n    // Check for HTML (starts with \u003c or whitespace+\u003c)\n    const str = head.toString('utf8').trim();\n    if (str.startsWith('\u003c') || str.startsWith('\u003c!')) {\n        throw new Error('MAGIC_BYTES_HTML: Content appears to be HTML');\n    }\n    \n    return 'unknown';  // Allow but log warning\n}\n```\n\n## Error Mapping\n\n- `CONTENT_TYPE_HTML` → Exit code 11 (AUTH_REQUIRED)\n- `MAGIC_BYTES_HTML` → Exit code 11 (AUTH_REQUIRED)\n\n## Testing\n\nCreate test cases with:\n1. Valid JPEG buffer\n2. Valid PNG buffer\n3. HTML response with `Content-Type: image/jpeg` (malicious CDN)\n4. HTML response with `Content-Type: text/html` (normal error page)\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T22:19:17.556380622-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:55:54.943548516-05:00","closed_at":"2026-01-03T22:55:54.943548516-05:00","close_reason":"Already implemented in giil script","dependencies":[{"issue_id":"get_icloud_image_link-hdm.1.3","depends_on_id":"get_icloud_image_link-hdm.1","type":"parent-child","created_at":"2026-01-03T22:19:17.585457455-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.1.4","title":"Implement extended exit codes (10-13, 20)","description":"## What\n\nExtend giil's exit codes for better scripting support while maintaining partial backwards compatibility.\n\n## BREAKING CHANGE WARNING\n\n**v3.0 changes exit codes 4 and 5.** Scripts checking these codes need updates.\n\n| v2 Code | v2 Meaning | v3 Code | Migration |\n|---------|------------|---------|-----------|\n| 4 | Network/timeout | 10 | Update: `if [ $? -eq 4 ]` → `if [ $? -eq 10 ]` |\n| 5 | Auth required | 11 | Update: `if [ $? -eq 5 ]` → `if [ $? -eq 11 ]` |\n\nCode 3 (dependency error) is **unchanged** for backwards compatibility.\n\n## Complete Exit Code Scheme (v3)\n\n| Code | Constant | Meaning | v2 Equivalent |\n|------|----------|---------|---------------|\n| 0 | SUCCESS | Success | 0 (same) |\n| 1 | CAPTURE_FAILURE | All strategies failed | 1 (same) |\n| 2 | USAGE_ERROR | Bad CLI options | 2 (same) |\n| 3 | DEPENDENCY_ERROR | Node.js/Playwright missing | 3 (same) ✓ |\n| 10 | NETWORK_ERROR | Timeout, DNS, unreachable | 4 (CHANGED) |\n| 11 | AUTH_REQUIRED | Login redirect, password | 5 (CHANGED) |\n| 12 | NOT_FOUND | Expired link, deleted, 404 | NEW |\n| 13 | UNSUPPORTED_TYPE | Video, Google Doc | NEW |\n| 20 | INTERNAL_ERROR | Bug in giil | NEW |\n\n## Design Rationale\n\n**Preserved (1-3):** Local/usage errors that haven't changed meaning.\n**Gap (4-9):** Reserved for future local errors. Avoids collision with old codes.\n**Remote (10-19):** All server/content-related failures.\n**Internal (20+):** Bugs in giil itself (please report!).\n\n## Implementation\n\n### Bash Layer\n```bash\nreadonly EXIT_SUCCESS=0\nreadonly EXIT_CAPTURE_FAILURE=1\nreadonly EXIT_USAGE_ERROR=2\nreadonly EXIT_DEPENDENCY_ERROR=3    # Preserved from v2!\nreadonly EXIT_NETWORK_ERROR=10      # Was 4 in v2\nreadonly EXIT_AUTH_REQUIRED=11      # Was 5 in v2\nreadonly EXIT_NOT_FOUND=12\nreadonly EXIT_UNSUPPORTED_TYPE=13\nreadonly EXIT_INTERNAL_ERROR=20\n```\n\n### JavaScript Layer\n```javascript\nconst ExitCodes = {\n    SUCCESS: 0,\n    CAPTURE_FAILURE: 1,\n    USAGE_ERROR: 2,\n    DEPENDENCY_ERROR: 3,\n    NETWORK_ERROR: 10,\n    AUTH_REQUIRED: 11,\n    NOT_FOUND: 12,\n    UNSUPPORTED_TYPE: 13,\n    INTERNAL_ERROR: 20\n};\n```\n\n## Migration Script for Users\n\n```bash\n#!/bin/bash\n# v2 → v3 exit code migration helper\nmap_exit_code() {\n    case $1 in\n        4) echo 10 ;;  # network\n        5) echo 11 ;;  # auth\n        *) echo $1 ;;  # unchanged\n    esac\n}\n```\n\n## Testing\n\n```bash\n# Simulate each error type and verify exit code\ngiil \"invalid-url\" 2\u003e/dev/null; echo \"Usage error: $?\"       # Should be 2\ngiil \"https://expired-link\" 2\u003e/dev/null; echo \"Not found: $?\" # Should be 12\n```\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:19:47.856044473-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:56:14.499004097-05:00","closed_at":"2026-01-03T22:56:14.499004097-05:00","close_reason":"Implemented extended exit codes (0-20) in both bash and JavaScript layers. Bash uses EXIT_DEPENDENCY_ERROR and EXIT_USAGE_ERROR, JS uses full ExitCodes object. Error handling in extractImage() maps errors to appropriate codes.","dependencies":[{"issue_id":"get_icloud_image_link-hdm.1.4","depends_on_id":"get_icloud_image_link-hdm.1","type":"parent-child","created_at":"2026-01-03T22:19:47.886125616-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.1.5","title":"Define Platform Adapter interface (JSDoc)","description":"## What\n\nDefine a clear interface/contract that all platform adapters must implement. This ensures consistency and makes adding new platforms straightforward.\n\n## Why JSDoc (Not TypeScript)\n\ngiil's extractor.mjs is vanilla JavaScript embedded in a bash heredoc. Converting to TypeScript would require:\n1. Build step (tsc compilation)\n2. Source maps for debugging\n3. More complex distribution\n\nJSDoc provides type checking in editors without runtime overhead.\n\n## Interface Definition\n\n```javascript\n/**\n * @typedef {Object} ResolvedItem\n * @property {string} url - The original or normalized URL\n * @property {string} [directUrl] - Direct download URL if available\n * @property {string} [filename] - Suggested filename from URL/headers\n * @property {number} [index] - Position in album (for --all mode)\n */\n\n/**\n * @typedef {Object} AcquireResult\n * @property {Buffer} bytes - The image data\n * @property {string} mime - MIME type (image/jpeg, image/png, etc.)\n * @property {string} platform - Platform identifier\n * @property {string} method - Capture method used\n * @property {number} tier - Strategy tier (1-4)\n * @property {string} [sourceUrl] - CDN URL where image was obtained\n * @property {boolean} [isPreview] - True if this is preview quality\n * @property {number} [width] - Image width in pixels\n * @property {number} [height] - Image height in pixels\n */\n\n/**\n * @typedef {Object} AcquireContext\n * @property {import('playwright').Page} page - Playwright page instance\n * @property {number} timeout - Timeout in milliseconds\n * @property {boolean} debug - Whether debug mode is enabled\n */\n\n/**\n * @typedef {Object} PlatformAdapter\n * @property {'icloud'|'dropbox'|'gphotos'|'gdrive'} id - Platform identifier\n * @property {(url: string) =\u003e boolean} match - Test if URL belongs to this platform\n * @property {(url: string) =\u003e string} normalize - Normalize URL to canonical form\n * @property {(url: string, opts: {all: boolean}) =\u003e Promise\u003cResolvedItem[]\u003e} resolveItems - Resolve single item or album\n * @property {(item: ResolvedItem, ctx: AcquireContext) =\u003e Promise\u003cAcquireResult\u003e} acquire - Acquire image bytes\n */\n```\n\n## Usage Pattern\n\n```javascript\n/** @type {PlatformAdapter} */\nconst dropboxAdapter = {\n    id: 'dropbox',\n    \n    match(url) {\n        return /dropbox\\.com\\/(?:s|scl\\/fi|sh)\\//.test(url);\n    },\n    \n    normalize(url) {\n        return url.replace(/[\u0026?](dl|raw)=[01]/g, '') + '\u0026raw=1';\n    },\n    \n    async resolveItems(url, { all }) {\n        // Dropbox doesn't support album mode via web\n        return [{ url: this.normalize(url) }];\n    },\n    \n    async acquire(item, ctx) {\n        // Direct download, no Playwright needed\n        const response = await fetch(item.url);\n        return {\n            bytes: Buffer.from(await response.arrayBuffer()),\n            mime: response.headers.get('content-type'),\n            platform: 'dropbox',\n            method: 'direct',\n            tier: 1\n        };\n    }\n};\n```\n\n## Benefits\n\n1. **Self-Documenting**: IDE shows types and descriptions\n2. **Consistency**: All platforms implement same interface\n3. **Testability**: Can mock adapters for unit tests\n4. **Extensibility**: Adding new platform = implementing interface\n","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-03T22:20:11.859721642-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:58:28.769207856-05:00","closed_at":"2026-01-03T22:58:28.769207856-05:00","close_reason":"Added JSDoc typedefs for ResolvedItem, AcquireResult, AcquireContext, and PlatformAdapter","dependencies":[{"issue_id":"get_icloud_image_link-hdm.1.5","depends_on_id":"get_icloud_image_link-hdm.1","type":"parent-child","created_at":"2026-01-03T22:20:11.888898101-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.1.6","title":"Add rate limiting for album downloads","description":"## What\n\nAdd polite delays between requests when downloading multiple photos in album mode.\n\n## Why This Matters\n\n1. **Don't hammer servers** - Rapid-fire requests can trigger rate limiting or bans\n2. **Be a good citizen** - Cloud providers have ToS about automated access\n3. **Reliability** - Slower, polite access is more likely to succeed long-term\n4. **Avoid detection** - Rate limiting makes giil look less like a bot\n\n## Default Behavior\n\n| Scenario | Delay |\n|----------|-------|\n| Between album photos | 1 second |\n| After rate limit (429) | Exponential backoff (2s, 4s, 8s) |\n| After server error (5xx) | 3 seconds, then retry |\n\n## Implementation\n\n```javascript\nconst ALBUM_DELAY_MS = 1000;  // 1 second between photos\nconst MAX_RETRIES = 3;\n\nasync function downloadAlbumWithRateLimit(photos, context) {\n    const results = [];\n    \n    for (let i = 0; i \u003c photos.length; i++) {\n        // Polite delay between photos (skip first)\n        if (i \u003e 0) {\n            await sleep(ALBUM_DELAY_MS);\n        }\n        \n        let retries = 0;\n        while (retries \u003c MAX_RETRIES) {\n            try {\n                const result = await downloadPhoto(photos[i], context);\n                results.push(result);\n                break;\n            } catch (e) {\n                if (e.statusCode === 429) {\n                    const backoff = Math.pow(2, retries + 1) * 1000;\n                    console.error(`[giil] Rate limited, waiting ${backoff/1000}s...`);\n                    await sleep(backoff);\n                    retries++;\n                } else if (e.statusCode \u003e= 500) {\n                    console.error(`[giil] Server error, retrying in 3s...`);\n                    await sleep(3000);\n                    retries++;\n                } else {\n                    throw e;  // Non-retryable error\n                }\n            }\n        }\n    }\n    \n    return results;\n}\n\nfunction sleep(ms) {\n    return new Promise(resolve =\u003e setTimeout(resolve, ms));\n}\n```\n\n## CLI Override\n\nAllow power users to adjust delay:\n\n```bash\n# Faster (risky)\ngiil \"https://...\" --all --delay 500\n\n# Slower (safer)\ngiil \"https://...\" --all --delay 3000\n\n# Parallel downloads (future enhancement)\ngiil \"https://...\" --all --jobs 3 --delay 500\n```\n\n## Per-Platform Considerations\n\n| Platform | Notes |\n|----------|-------|\n| iCloud | Conservative - Apple may block aggressive access |\n| Dropbox | No browser = fast already, minimal delay needed |\n| Google Photos | Moderate - Google has good rate limiting |\n| Google Drive | Conservative - API quotas are strict |\n\n## Progress Indication\n\nShow download progress with rate limit info:\n\n```\n[giil] Downloading album: 12 photos\n[giil] [1/12] Downloading photo 1... done (2.1 MB)\n[giil] [2/12] Downloading photo 2... done (1.8 MB)\n[giil] [3/12] Downloading photo 3... rate limited, waiting 2s...\n[giil] [3/12] Downloading photo 3... done (2.4 MB)\n```\n\n## Testing\n\nAdd test for rate limit handling:\n\n```javascript\nit('respects rate limiting', async () =\u003e {\n    const mockServer = setupMockServerWithRateLimit();\n    const results = await downloadAlbum(mockServer.url, { all: true });\n    \n    // Verify delays were applied\n    expect(mockServer.requestTimestamps.length).toBeGreaterThan(1);\n    const delays = computeDelays(mockServer.requestTimestamps);\n    expect(Math.min(...delays)).toBeGreaterThanOrEqual(ALBUM_DELAY_MS);\n});\n```\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:44:19.619005191-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:57:29.725593949-05:00","closed_at":"2026-01-03T22:57:29.725593949-05:00","close_reason":"Added ALBUM_DELAY_MS constant and polite delay in album mode loop","dependencies":[{"issue_id":"get_icloud_image_link-hdm.1.6","depends_on_id":"get_icloud_image_link-hdm.1","type":"parent-child","created_at":"2026-01-03T22:44:19.647667415-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.2","title":"EPIC: Phase 2 - Dropbox Support","description":"## Overview\n\nAdd full Dropbox support to giil. This is the **highest-value, lowest-effort** platform to add.\n\n## Why Dropbox First\n\n1. **No Playwright needed**: Simple URL parameter change enables direct curl download\n2. **Faster execution**: 1-3 seconds vs 5-15 seconds with browser\n3. **Lower resource usage**: No Chromium process\n4. **More reliable**: Fewer moving parts\n5. **Proven approach**: Well-documented `raw=1` parameter\n\n## Research Findings (Jan 2026)\n\n### URL Transformation\n```\nInput:  https://www.dropbox.com/scl/fi/xxx/photo.png?rlkey=abc\u0026dl=0\nOutput: https://www.dropbox.com/scl/fi/xxx/photo.png?rlkey=abc\u0026raw=1\n```\n\n### Test Results\n| Method | Resolution | Size | Status |\n|--------|-----------|------|--------|\n| Direct URL (raw=1) | 2760×2288 | 2.27 MB | ✅ Full |\n| Playwright network | 1600×1326 | 1.29 MB | ⚠️ Preview |\n\n### Key Insight\nPlaywright network interception only captures preview-resolution images from `previews.dropboxusercontent.com`. The `raw=1` direct download is the ONLY way to get full resolution.\n\n## URL Formats to Support\n\n```\nStandard share:  https://www.dropbox.com/scl/fi/{FILE_ID}/{FILENAME}?rlkey={KEY}\u0026dl=0\nLegacy share:    https://www.dropbox.com/s/{FILE_ID}/{FILENAME}?dl=0\nFolder share:    https://www.dropbox.com/sh/{FOLDER_ID}/{FOLDER_NAME}?dl=0\n```\n\n## Edge Cases\n\n1. **Password-protected shares**: Return HTML login form with 200 OK\n2. **Expired links**: Return HTML error page with 200 OK\n3. **Large files**: May need progress indication\n4. **Folder downloads**: Return ZIP (future enhancement)\n\n## Critical: Content Validation\n\nDropbox returns HTML for errors but with HTTP 200. MUST validate:\n1. Content-Type header (reject text/html)\n2. Magic bytes (detect HTML in body)\n\nWithout this, giil would silently save HTML as \"photo.jpg\".\n\n## Success Criteria\n\n- [ ] `giil \"https://dropbox.com/...\"` downloads at full resolution\n- [ ] No Playwright process spawned for Dropbox URLs\n- [ ] Clear error for password-protected links\n- [ ] Clear error for expired links\n- [ ] JSON output includes `platform: \"dropbox\"`\n","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-03T22:20:36.59403518-05:00","created_by":"ubuntu","updated_at":"2026-01-04T01:05:46.29125226-05:00","closed_at":"2026-01-04T01:05:46.29125226-05:00","close_reason":"Phase 2 Dropbox Support complete: normalize_dropbox_url(), download_dropbox_direct(), platform detection integration. Full-resolution direct downloads without Playwright.","dependencies":[{"issue_id":"get_icloud_image_link-hdm.2","depends_on_id":"get_icloud_image_link-hdm","type":"parent-child","created_at":"2026-01-03T22:20:36.6228984-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.2","depends_on_id":"get_icloud_image_link-hdm.1","type":"blocks","created_at":"2026-01-03T22:27:23.790850051-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.2.1","title":"Implement normalize_dropbox_url() in bash","description":"## What\n\nAdd a function to transform Dropbox share URLs into direct download URLs.\n\n## Implementation\n\n```bash\nnormalize_dropbox_url() {\n    local url=\"$1\"\n    \n    # Remove existing dl= or raw= parameters\n    url=$(echo \"$url\" | sed -E 's/[\u0026?](dl|raw)=[01]//g')\n    \n    # Add raw=1 parameter\n    if [[ \"$url\" == *\"?\"* ]]; then\n        echo \"${url}\u0026raw=1\"\n    else\n        echo \"${url}?raw=1\"\n    fi\n}\n```\n\n## Why raw=1 Instead of dl=1\n\n| Parameter | Behavior |\n|-----------|----------|\n| `dl=0` | Web preview (default) |\n| `dl=1` | Force download, `Content-Type: application/binary` |\n| `raw=1` | Raw file, **correct MIME type** |\n\nUsing `raw=1` returns the correct `Content-Type` header, which helps with:\n1. Content validation (we can check for image/* types)\n2. Proper file handling by downstream tools\n3. Browser compatibility (if URL is used elsewhere)\n\n## Test Cases\n\n```bash\n# Standard share URL\nnormalize_dropbox_url \"https://www.dropbox.com/scl/fi/xxx/photo.png?rlkey=abc\u0026dl=0\"\n# Expected: https://www.dropbox.com/scl/fi/xxx/photo.png?rlkey=abc\u0026raw=1\n\n# URL without any dl parameter\nnormalize_dropbox_url \"https://www.dropbox.com/s/xxx/photo.png\"\n# Expected: https://www.dropbox.com/s/xxx/photo.png?raw=1\n\n# URL with raw=0 (someone manually changed it)\nnormalize_dropbox_url \"https://www.dropbox.com/s/xxx/photo.png?raw=0\"\n# Expected: https://www.dropbox.com/s/xxx/photo.png?raw=1\n```\n\n## Edge Case: Multiple Query Parameters\n\nThe sed replacement handles both `?dl=0` and `\u0026dl=0` cases. The `[\u0026?]` pattern matches either.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:20:54.899703243-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:59:30.056316044-05:00","closed_at":"2026-01-03T22:59:30.056316044-05:00","close_reason":"Implemented normalize_dropbox_url() with sed-based dl=0/raw=0 replacement and raw=1 addition. Tests pass for all URL formats.","dependencies":[{"issue_id":"get_icloud_image_link-hdm.2.1","depends_on_id":"get_icloud_image_link-hdm.2","type":"parent-child","created_at":"2026-01-03T22:20:54.928624792-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.2.2","title":"Implement Dropbox direct download (skip Playwright)","description":"## What\n\nAdd a fast path in the bash layer that downloads Dropbox files directly via curl, completely bypassing Playwright.\n\n## Why This Matters\n\n| Approach | Time | Memory | Reliability |\n|----------|------|--------|-------------|\n| Playwright | 5-15s | 300MB+ | Browser can fail |\n| Direct curl | 1-3s | \u003c10MB | Simple HTTP |\n\nFor Dropbox, Playwright provides WORSE quality (preview resolution). Direct download is the ONLY correct approach.\n\n## Implementation\n\n```bash\ndownload_dropbox_direct() {\n    local url=\"$1\"\n    local output_dir=\"$2\"\n    local quality=\"$3\"\n    local json_output=\"$4\"\n    \n    # Normalize URL to raw format\n    local raw_url\n    raw_url=$(normalize_dropbox_url \"$url\")\n    \n    # Extract filename from URL\n    local filename\n    filename=$(basename \"${url%%\\?*}\")\n    \n    # Generate output path with timestamp\n    local timestamp\n    timestamp=$(date +%Y%m%d_%H%M%S)\n    local output_path=\"${output_dir}/dropbox_${timestamp}.jpg\"\n    \n    # Download with curl\n    local http_code\n    http_code=$(curl -sL -w \"%{http_code}\" \"$raw_url\" -o \"$output_path\")\n    \n    if [[ \"$http_code\" != \"200\" ]]; then\n        log_error \"Download failed with HTTP $http_code\"\n        rm -f \"$output_path\"\n        return $EXIT_NETWORK_ERROR\n    fi\n    \n    # Validate content (check for HTML)\n    local content_type\n    content_type=$(file --mime-type -b \"$output_path\")\n    if [[ \"$content_type\" == \"text/html\" ]]; then\n        log_error \"Received HTML instead of image. Link may be password-protected or expired.\"\n        rm -f \"$output_path\"\n        return $EXIT_AUTH_REQUIRED\n    fi\n    \n    # Output result\n    echo \"$output_path\"\n    return $EXIT_SUCCESS\n}\n```\n\n## Integration in Main Flow\n\n```bash\nmain() {\n    # ... parse args ...\n    \n    local platform\n    platform=$(detect_platform \"$URL\")\n    \n    case \"$platform\" in\n        dropbox)\n            # Fast path: no Playwright needed\n            download_dropbox_direct \"$URL\" \"$OUTPUT_DIR\" \"$QUALITY\" \"$JSON_OUTPUT\"\n            exit $?\n            ;;\n        *)\n            # Standard path: use Playwright extractor\n            ensure_playwright\n            node extractor.mjs \"$URL\" ...\n            ;;\n    esac\n}\n```\n\n## Key Points\n\n1. **Exit early**: Dropbox never reaches the Playwright code path\n2. **Validate content**: Check file type after download\n3. **Clean up on error**: Remove partial downloads\n4. **Report clearly**: Use new exit codes (11 for auth, 10 for network)\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T22:21:16.330645358-05:00","created_by":"ubuntu","updated_at":"2026-01-04T01:05:46.249120365-05:00","closed_at":"2026-01-04T01:05:46.249120365-05:00","close_reason":"Implemented download_dropbox_direct() with curl download, content validation, HTTP error handling, and JSON/base64 output modes. Completely bypasses Playwright for faster downloads.","dependencies":[{"issue_id":"get_icloud_image_link-hdm.2.2","depends_on_id":"get_icloud_image_link-hdm.2","type":"parent-child","created_at":"2026-01-03T22:21:16.36069909-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.2.2","depends_on_id":"get_icloud_image_link-hdm.2.1","type":"blocks","created_at":"2026-01-03T22:27:34.226850452-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.2.3","title":"Add Dropbox error handling (password/expired)","description":"## What\n\nImplement clear, actionable error messages for Dropbox failure modes.\n\n## Error Scenarios\n\n### 1. Password-Protected Link\nDropbox returns HTTP 200 with HTML containing password form.\n\n**Detection:**\n```bash\nif grep -q \"password\" \"$output_path\" 2\u003e/dev/null; then\n    # Password required\nfi\n```\n\n**Message:**\n```\n[giil] Error: This Dropbox link requires a password.\n[giil] \n[giil] giil does not support password-protected shares.\n[giil] Options:\n[giil]   1. Ask the owner to create a password-free share\n[giil]   2. Open the link in a browser and download manually\n```\n\n### 2. Expired Link\nDropbox returns HTTP 200 with HTML error page.\n\n**Detection:**\n```bash\nif grep -qi \"expired\\|no longer available\" \"$output_path\" 2\u003e/dev/null; then\n    # Link expired\nfi\n```\n\n**Message:**\n```\n[giil] Error: This Dropbox link has expired or been revoked.\n[giil] \n[giil] The file owner may have:\n[giil]   - Deleted the file\n[giil]   - Changed sharing settings\n[giil]   - Set an expiration date that has passed\n[giil] \n[giil] Ask the owner for a new share link.\n```\n\n### 3. File Not Found (404)\nHTTP 404 status code.\n\n**Message:**\n```\n[giil] Error: Dropbox file not found (404).\n[giil] \n[giil] The link may be invalid or the file was deleted.\n```\n\n### 4. Rate Limited (429)\nHTTP 429 status code.\n\n**Message:**\n```\n[giil] Error: Too many requests to Dropbox.\n[giil] \n[giil] Please wait a few minutes and try again.\n```\n\n## Implementation Pattern\n\n```bash\nhandle_dropbox_error() {\n    local http_code=\"$1\"\n    local output_path=\"$2\"\n    \n    case \"$http_code\" in\n        429)\n            log_error \"Too many requests to Dropbox. Please wait and try again.\"\n            return $EXIT_NETWORK_ERROR\n            ;;\n        404)\n            log_error \"Dropbox file not found (404).\"\n            return $EXIT_NOT_FOUND\n            ;;\n        200)\n            # Check if it's actually HTML (error page)\n            if file --mime-type -b \"$output_path\" | grep -q \"text/html\"; then\n                if grep -qi \"password\" \"$output_path\"; then\n                    log_error \"This Dropbox link requires a password.\"\n                    log_error \"giil does not support password-protected shares.\"\n                    return $EXIT_AUTH_REQUIRED\n                elif grep -qi \"expired\" \"$output_path\"; then\n                    log_error \"This Dropbox link has expired.\"\n                    return $EXIT_NOT_FOUND\n                else\n                    log_error \"Received HTML instead of image.\"\n                    return $EXIT_AUTH_REQUIRED\n                fi\n            fi\n            return $EXIT_SUCCESS\n            ;;\n        *)\n            log_error \"Dropbox download failed with HTTP $http_code\"\n            return $EXIT_NETWORK_ERROR\n            ;;\n    esac\n}\n```\n\n## Exit Code Mapping\n\n| Scenario | Exit Code |\n|----------|-----------|\n| Password required | 11 (AUTH_REQUIRED) |\n| Link expired | 12 (NOT_FOUND) |\n| File deleted | 12 (NOT_FOUND) |\n| Rate limited | 10 (NETWORK_ERROR) |\n| Unknown HTML | 11 (AUTH_REQUIRED) |\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:21:50.340974644-05:00","created_by":"ubuntu","updated_at":"2026-01-04T01:05:46.271667887-05:00","closed_at":"2026-01-04T01:05:46.271667887-05:00","close_reason":"Error handling integrated into hdm.2.2: HTTP 404-\u003eEXIT_NOT_FOUND, 401/403-\u003eEXIT_AUTH_REQUIRED, HTML content-\u003eEXIT_AUTH_REQUIRED with descriptive messages.","dependencies":[{"issue_id":"get_icloud_image_link-hdm.2.3","depends_on_id":"get_icloud_image_link-hdm.2","type":"parent-child","created_at":"2026-01-03T22:21:50.370378332-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.2.3","depends_on_id":"get_icloud_image_link-hdm.2.2","type":"blocks","created_at":"2026-01-03T22:27:34.244639454-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.3","title":"EPIC: Phase 3 - Google Photos Support","description":"## Overview\n\nAdd Google Photos support to giil. This requires Playwright for URL extraction but enables full-resolution downloads.\n\n## Research Findings (Jan 2026)\n\n### The Key Discovery\n\nGoogle Photos CDN URLs include size modifiers:\n- Default preview: `=w1042-h862-no` (1040×862)\n- **Full resolution: `=s0`** (original size)\n\nSimply appending `=s0` to the base URL returns the original image!\n\n### Test Results\n| Method | Resolution | Size | Status |\n|--------|-----------|------|--------|\n| URL extract + =s0 | 2760×2288 | 2.14 MB | ✅ Full |\n| Playwright network | 1040×862 | 624 KB | ⚠️ Preview |\n\n### URL Formats\n```\nShort link:  https://photos.app.goo.gl/{SHARE_ID}\nFull link:   https://photos.google.com/share/{ALBUM_ID}?key={KEY}\n```\n\n### CDN Pattern\n```\nBase:    https://lh3.googleusercontent.com/pw/{IMAGE_PATH}\nPreview: https://lh3.googleusercontent.com/pw/{IMAGE_PATH}=w1042-h862-no\nFull:    https://lh3.googleusercontent.com/pw/{IMAGE_PATH}=s0\n```\n\n## Strategy\n\n1. **Load page with Playwright** (for URL extraction)\n2. **Intercept network requests** to capture CDN base URL\n3. **Extract base URL** (remove size modifier)\n4. **Download directly** with `=s0` appended\n5. **Validate content** (ensure it's an image, not HTML)\n\n## Album Support\n\nGoogle Photos albums show thumbnails that can be clicked to view full-size. For `--all` mode:\n\n1. Collect all thumbnail URLs from network traffic\n2. OR query for thumbnail elements (multiple selector strategies)\n3. For each image: extract base URL, download with `=s0`\n\n### Selector Strategies (Ordered by Stability)\n```javascript\n// Prefer semantic selectors\n'[role=\"listitem\"] a',\n'a[aria-label*=\"photo\" i]',\n\n// Fall back to observed structures\n'[data-latest-bg]',\n'.RY3tic',\n'[style*=\"background-image\"]'\n```\n\n## Edge Cases\n\n1. **Private albums**: Redirect to login → detect and report\n2. **Single photo vs album**: Different DOM structure\n3. **Video content**: Skip with warning or `--include-videos`\n\n## 2025 API Changes\n\n\u003e From March 31, 2025, rclone can only download photos it uploaded.\n\nThis affects API-based tools but NOT giil (browser-based scraping of public web interface).\n\n## Success Criteria\n\n- [ ] `giil \"https://photos.app.goo.gl/...\"` downloads at full resolution\n- [ ] Short links (goo.gl) are followed to full URLs\n- [ ] `--all` mode downloads all photos in album\n- [ ] Clear error for private albums\n- [ ] JSON output includes `platform: \"gphotos\"`\n","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-03T22:22:16.522453093-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:22:16.522453093-05:00","dependencies":[{"issue_id":"get_icloud_image_link-hdm.3","depends_on_id":"get_icloud_image_link-hdm","type":"parent-child","created_at":"2026-01-03T22:22:16.551984391-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.3","depends_on_id":"get_icloud_image_link-hdm.1","type":"blocks","created_at":"2026-01-03T22:27:23.835618266-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.3.1","title":"Implement Google Photos CDN URL extraction","description":"## What\n\nCapture Google Photos CDN URLs during page load and extract the base URL for full-resolution download.\n\n## The Strategy\n\n1. Install network interceptor BEFORE navigation\n2. Capture all `lh3.googleusercontent.com/pw/` URLs\n3. Extract base URL (everything before the `=` size modifier)\n4. Download full resolution using `{baseUrl}=s0`\n\n## Implementation\n\n```javascript\nasync function captureGooglePhotos(page, url) {\n    const cdnUrls = new Set();\n    \n    // Install network interceptor BEFORE navigation\n    page.on('response', async (response) =\u003e {\n        const respUrl = response.url();\n        \n        // Capture Google Photos CDN URLs\n        if (respUrl.includes('lh3.googleusercontent.com/pw/')) {\n            // Extract base URL (before size modifier)\n            const baseUrl = respUrl.split('=')[0];\n            cdnUrls.add(baseUrl);\n        }\n    });\n\n    // Navigate to the share page\n    await page.goto(url, { waitUntil: 'domcontentloaded' });\n\n    // Wait for image to load (use element presence, not networkidle)\n    await Promise.race([\n        page.waitForSelector('[data-latest-bg], .RY3tic, img[src*=\"googleusercontent\"]', \n            { timeout: 15000 }).catch(() =\u003e {}),\n        page.waitForTimeout(5000)  // Fallback timeout\n    ]);\n\n    // Get the best URL (prefer largest if multiple)\n    if (cdnUrls.size === 0) {\n        throw new Error('No Google Photos CDN URL found');\n    }\n\n    // Use the first captured URL (for single photo)\n    // For albums, we'd iterate through all\n    const baseUrl = Array.from(cdnUrls)[0];\n    const fullResUrl = `${baseUrl}=s0`;\n\n    // Download full resolution directly\n    const response = await fetch(fullResUrl);\n    if (!response.ok) {\n        throw new Error(`Failed to download: HTTP ${response.status}`);\n    }\n\n    return {\n        bytes: Buffer.from(await response.arrayBuffer()),\n        mime: response.headers.get('content-type'),\n        platform: 'gphotos',\n        method: 'url-extraction',\n        tier: 1,\n        sourceUrl: fullResUrl\n    };\n}\n```\n\n## Size Modifier Reference\n\n| Modifier | Result |\n|----------|--------|\n| `=w1042-h862-no` | Constrained to 1042×862 |\n| `=w0` | Full width |\n| `=s0` | **Original size** |\n| `=w4000` | Capped at 4000px or original |\n\n## Why `=s0`?\n\nThe `s` parameter specifies \"size\" without aspect ratio constraints. `=s0` means \"size 0\" which Google interprets as \"original/unlimited\".\n\n## Error Handling\n\n```javascript\n// Detect private album (redirects to login)\nif (page.url().includes('accounts.google.com')) {\n    throw new Error('AUTH_REQUIRED: Album is private. Only public shares are supported.');\n}\n\n// Detect empty album\nif (cdnUrls.size === 0 \u0026\u0026 await page.$('.empty-album-message')) {\n    throw new Error('NOT_FOUND: Album appears to be empty.');\n}\n```\n","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-01-03T22:23:02.017755053-05:00","created_by":"ubuntu","updated_at":"2026-01-03T23:00:57.743323621-05:00","dependencies":[{"issue_id":"get_icloud_image_link-hdm.3.1","depends_on_id":"get_icloud_image_link-hdm.3","type":"parent-child","created_at":"2026-01-03T22:23:02.046759229-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.3.2","title":"Implement Google Photos album mode (--all)","description":"## What\n\nSupport downloading all photos from a shared Google Photos album using the `--all` flag.\n\n## Strategy: Multi-Signal Approach\n\nAlbum detection is fragile because Google's class names change. Use multiple signals:\n\n### Signal 1: Network Traffic (Most Reliable)\nCollect all unique `lh3.googleusercontent.com/pw/` base URLs during page load.\n\n```javascript\nconst albumUrls = new Set();\n\npage.on('response', (response) =\u003e {\n    const url = response.url();\n    if (url.includes('lh3.googleusercontent.com/pw/')) {\n        albumUrls.add(url.split('=')[0]);  // Base URL\n    }\n});\n```\n\n### Signal 2: Semantic Selectors (More Stable)\n```javascript\nconst thumbnailSelectors = [\n    // Semantic (preferred)\n    '[role=\"listitem\"] a',\n    'a[aria-label*=\"photo\" i]',\n    '[role=\"img\"]',\n    \n    // Observed structures (fallback)\n    '[data-latest-bg]',\n    '.RY3tic',\n    '[style*=\"background-image\"]'\n];\n```\n\n### Signal 3: Background Image URLs\n```javascript\nasync function extractBackgroundUrls(page) {\n    return await page.evaluate(() =\u003e {\n        const urls = [];\n        document.querySelectorAll('[style*=\"background-image\"]').forEach(el =\u003e {\n            const style = el.style.backgroundImage;\n            const match = style.match(/url\\(\"([^\"]+lh3\\.googleusercontent[^\"]+)\"\\)/);\n            if (match) urls.push(match[1].split('=')[0]);\n        });\n        return urls;\n    });\n}\n```\n\n## Implementation\n\n```javascript\nasync function captureGooglePhotosAlbum(page, url) {\n    const results = [];\n    const collectedUrls = new Set();\n\n    // Install interceptor for thumbnails\n    page.on('response', (response) =\u003e {\n        const respUrl = response.url();\n        if (respUrl.includes('lh3.googleusercontent.com/pw/')) {\n            collectedUrls.add(respUrl.split('=')[0]);\n        }\n    });\n\n    await page.goto(url, { waitUntil: 'domcontentloaded' });\n    \n    // Wait for thumbnails to load\n    await page.waitForLoadState('networkidle', { timeout: 15000 }).catch(() =\u003e {});\n\n    // Scroll to load more thumbnails (if lazy-loaded)\n    await scrollToLoadAll(page);\n\n    // Combine with background image extraction\n    const bgUrls = await extractBackgroundUrls(page);\n    bgUrls.forEach(u =\u003e collectedUrls.add(u));\n\n    // Download each unique URL with =s0\n    let index = 1;\n    for (const baseUrl of collectedUrls) {\n        try {\n            const fullUrl = `${baseUrl}=s0`;\n            const response = await fetch(fullUrl);\n            \n            if (!response.ok) continue;\n\n            results.push({\n                bytes: Buffer.from(await response.arrayBuffer()),\n                platform: 'gphotos',\n                method: 'url-extraction',\n                tier: 1,\n                sourceUrl: fullUrl,\n                index: index++\n            });\n        } catch (err) {\n            console.error(`[giil] Photo ${index} failed: ${err.message}`);\n            // Continue to next photo\n        }\n    }\n\n    return results;\n}\n\nasync function scrollToLoadAll(page, maxScrolls = 10) {\n    for (let i = 0; i \u003c maxScrolls; i++) {\n        const prevHeight = await page.evaluate(() =\u003e document.body.scrollHeight);\n        await page.evaluate(() =\u003e window.scrollTo(0, document.body.scrollHeight));\n        await page.waitForTimeout(1000);\n        const newHeight = await page.evaluate(() =\u003e document.body.scrollHeight);\n        if (newHeight === prevHeight) break;  // No more content\n    }\n}\n```\n\n## Output (--json mode)\n\nEach photo outputs a separate JSON line:\n```json\n{\"path\": \"gphotos_20260103_142245_001.jpg\", \"platform\": \"gphotos\", \"method\": \"url-extraction\", ...}\n{\"path\": \"gphotos_20260103_142246_002.jpg\", \"platform\": \"gphotos\", \"method\": \"url-extraction\", ...}\n```\n\n## Edge Cases\n\n1. **Large albums**: Scroll pagination to load all thumbnails\n2. **Videos in album**: Skip with warning (or `--include-videos`)\n3. **Private album**: Detect login redirect, fail with clear message\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T22:23:31.692457906-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:23:31.692457906-05:00","dependencies":[{"issue_id":"get_icloud_image_link-hdm.3.2","depends_on_id":"get_icloud_image_link-hdm.3","type":"parent-child","created_at":"2026-01-03T22:23:31.712263183-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.3.2","depends_on_id":"get_icloud_image_link-hdm.3.1","type":"blocks","created_at":"2026-01-03T22:27:34.26283479-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.4","title":"EPIC: Phase 4 - Google Drive Support (Experimental)","description":"## Overview\n\nAdd Google Drive support to giil. This is the most complex platform due to 2024 API changes and strict sharing requirements.\n\n**CRITICAL: Ship as [experimental] in v3.0**\n\n## Why Experimental\n\n1. **2024 API changes**: Direct download URLs (`/uc?export=download`) now frequently return 403\n2. **Strict sharing**: Only works with \"Anyone with the link\" permission\n3. **Complex failure modes**: Many ways to fail, all return HTTP 200 with HTML\n4. **Unreliable direct URLs**: Thumbnail endpoints may return lower resolution\n\n## Research Findings (Jan 2026)\n\n### Test Results (Private File)\n```\nAll methods redirected to Google login:\n- /uc?export=view     → accounts.google.com (HTML)\n- /uc?export=download → accounts.google.com (HTML)\n- /thumbnail?sz=w2000 → accounts.google.com (HTML)\n- Playwright          → accounts.google.com (HTML)\n\nConclusion: File requires \"Anyone with the link\" sharing\n```\n\n### URL Formats\n```\nView:      https://drive.google.com/file/d/{FILE_ID}/view\nOpen:      https://drive.google.com/open?id={FILE_ID}\nDownload:  https://drive.google.com/uc?export=download\u0026id={FILE_ID}\nThumbnail: https://drive.google.com/thumbnail?id={FILE_ID}\u0026sz=w{SIZE}\n```\n\n### File ID Extraction\n```javascript\nconst patterns = [\n    /\\/file\\/d\\/([a-zA-Z0-9_-]+)/,\n    /\\/open\\?id=([a-zA-Z0-9_-]+)/,\n    /[?\u0026]id=([a-zA-Z0-9_-]+)/\n];\n```\n\n## Multi-Tier Strategy\n\n1. **Check if public**: Navigate to view URL, detect login redirect\n2. **Try download button**: Click aria-label=\"Download\" if visible\n3. **Try direct download**: `/uc?export=download\u0026id={fileId}`\n4. **Try thumbnail**: `/thumbnail?id={fileId}\u0026sz=w4000` (may be lower res)\n5. **Screenshot fallback**: Element or viewport screenshot\n\n## Required User Action\n\nFor Drive to work, file owner MUST:\n1. Right-click file → Share → General access\n2. Change \"Restricted\" to \"Anyone with the link\"\n3. Click Done\n\n## Edge Cases\n\n1. **Large files (\u003e100MB)**: Virus scan warning bypass\n2. **Google Docs/Sheets**: Not images, detect and skip\n3. **Quota exceeded**: Rate limiting, implement backoff\n\n## Success Criteria\n\n- [ ] Public images download correctly\n- [ ] Private files show clear \"not shared\" error with remediation steps\n- [ ] Help text marks Drive as [experimental]\n- [ ] JSON output includes `platform: \"gdrive\"`\n\n## Non-Goals (v3.0)\n\n- No authenticated mode (user login)\n- No cookie persistence\n- No bypassing login/CAPTCHA\n","status":"open","priority":2,"issue_type":"epic","created_at":"2026-01-03T22:23:59.346890157-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:23:59.346890157-05:00","dependencies":[{"issue_id":"get_icloud_image_link-hdm.4","depends_on_id":"get_icloud_image_link-hdm","type":"parent-child","created_at":"2026-01-03T22:23:59.376788496-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.4","depends_on_id":"get_icloud_image_link-hdm.1","type":"blocks","created_at":"2026-01-03T22:27:23.853045096-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.4.1","title":"Implement Google Drive file ID extraction","description":"## What\n\nExtract the file ID from various Google Drive URL formats.\n\n## Implementation\n\n```javascript\nfunction extractGoogleDriveFileId(url) {\n    const patterns = [\n        /\\/file\\/d\\/([a-zA-Z0-9_-]+)/,      // /file/d/{id}/view\n        /\\/open\\?id=([a-zA-Z0-9_-]+)/,       // /open?id={id}\n        /[?\u0026]id=([a-zA-Z0-9_-]+)/            // ?id={id} or \u0026id={id}\n    ];\n\n    for (const pattern of patterns) {\n        const match = url.match(pattern);\n        if (match) return match[1];\n    }\n    return null;\n}\n```\n\n## URL Format Examples\n\n| Input URL | Extracted ID |\n|-----------|--------------|\n| `https://drive.google.com/file/d/1ABC123xyz/view` | `1ABC123xyz` |\n| `https://drive.google.com/open?id=1ABC123xyz` | `1ABC123xyz` |\n| `https://drive.google.com/uc?id=1ABC123xyz\u0026export=download` | `1ABC123xyz` |\n\n## Error Handling\n\n```javascript\nconst fileId = extractGoogleDriveFileId(url);\nif (!fileId) {\n    throw new Error('USAGE_ERROR: Could not extract file ID from Google Drive URL');\n}\n```\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T22:24:21.453670636-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:24:21.453670636-05:00","dependencies":[{"issue_id":"get_icloud_image_link-hdm.4.1","depends_on_id":"get_icloud_image_link-hdm.4","type":"parent-child","created_at":"2026-01-03T22:24:21.482643503-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.4.2","title":"Implement Google Drive auth detection","description":"## What\n\nDetect when a Google Drive file requires authentication and provide clear, actionable error messages.\n\n## Detection Strategy\n\n### 1. Login Redirect Detection\n```javascript\nasync function checkDriveAuth(page, fileId) {\n    const viewUrl = `https://drive.google.com/file/d/${fileId}/view`;\n    await page.goto(viewUrl, { waitUntil: 'domcontentloaded', timeout: 15000 });\n\n    // Check for login redirect\n    const currentUrl = page.url();\n    if (currentUrl.includes('accounts.google.com')) {\n        throw new DriveAuthError('File requires authentication. Not publicly shared.');\n    }\n\n    // Check for \"request access\" page\n    const requestAccessBtn = await page.$('button:has-text(\"Request access\")');\n    if (requestAccessBtn) {\n        throw new DriveAuthError('File is restricted. Owner must grant access.');\n    }\n}\n```\n\n### 2. API Response Detection\n```javascript\n// Some Drive URLs return 200 with HTML error page\nasync function validateDriveResponse(buffer) {\n    const text = buffer.toString('utf8', 0, 1000);\n    \n    if (text.includes('accounts.google.com/ServiceLogin')) {\n        throw new DriveAuthError('Login required');\n    }\n    \n    if (text.includes('Request access') || text.includes('You need permission')) {\n        throw new DriveAuthError('Access denied');\n    }\n    \n    if (text.includes('Sorry, the file you have requested does not exist')) {\n        throw new DriveNotFoundError('File not found or deleted');\n    }\n}\n```\n\n## Error Messages\n\n### Not Publicly Shared\n```\n[giil] Error: Google Drive file is not publicly shared\n[giil]\n[giil] The file owner must:\n[giil]   1. Right-click the file in Google Drive\n[giil]   2. Click \"Share\" → \"General access\"\n[giil]   3. Change \"Restricted\" to \"Anyone with the link\"\n[giil]   4. Click \"Done\"\n[giil]\n[giil] Then try again with the same URL.\n```\n\n### File Not Found\n```\n[giil] Error: Google Drive file not found\n[giil]\n[giil] The file may have been:\n[giil]   - Deleted by the owner\n[giil]   - Moved to a different location\n[giil]   - The URL may be incorrect\n```\n\n## Exit Code Mapping\n\n| Scenario | Exit Code |\n|----------|-----------|\n| Login redirect | 11 (AUTH_REQUIRED) |\n| Request access page | 11 (AUTH_REQUIRED) |\n| File not found | 12 (NOT_FOUND) |\n| Download quota | 10 (NETWORK_ERROR) |\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-03T22:24:39.658234412-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:24:39.658234412-05:00","dependencies":[{"issue_id":"get_icloud_image_link-hdm.4.2","depends_on_id":"get_icloud_image_link-hdm.4","type":"parent-child","created_at":"2026-01-03T22:24:39.688672167-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.4.2","depends_on_id":"get_icloud_image_link-hdm.4.1","type":"blocks","created_at":"2026-01-03T22:27:34.280644551-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.4.3","title":"Implement Google Drive capture strategy","description":"## What\n\nImplement the multi-tier capture strategy for downloading images from Google Drive.\n\n## Problem\n\nAfter detecting that a file IS publicly shared (hdm.4.2), we need to actually download it. Google Drive has multiple methods with varying reliability:\n\n| Method | Quality | Reliability | Notes |\n|--------|---------|-------------|-------|\n| Download button click | Original | Medium | Button may not appear immediately |\n| Direct URL (`/uc?export=download`) | Original | Low | Often 403s after 2024 changes |\n| Thumbnail URL (`/thumbnail?sz=w4000`) | High but not original | Medium | Capped at 4000px |\n| Playwright screenshot | Rendered | Always works | Last resort |\n\n## Implementation\n\n```javascript\nasync function captureGoogleDrive(page, fileId) {\n    // TIER 1: Download button\n    const downloadBtn = await page.$(\n        'button[aria-label=\"Download\"], [data-tooltip=\"Download\"]'\n    );\n    if (downloadBtn) {\n        const downloadPromise = page.waitForEvent('download', { timeout: 10000 });\n        await downloadBtn.click();\n        const download = await downloadPromise;\n        const buffer = await download.path().then(p =\u003e readFileSync(p));\n        return { bytes: buffer, method: 'download-button', tier: 1 };\n    }\n\n    // TIER 2: Direct download URL\n    try {\n        const directUrl = `https://drive.google.com/uc?export=download\u0026id=${fileId}`;\n        const response = await fetch(directUrl, { redirect: 'follow' });\n        \n        // Check if we got HTML instead of image\n        const contentType = response.headers.get('content-type');\n        if (contentType?.startsWith('image/')) {\n            return { \n                bytes: Buffer.from(await response.arrayBuffer()), \n                method: 'direct-url', \n                tier: 2 \n            };\n        }\n    } catch (e) {\n        console.error('[giil] Direct download failed:', e.message);\n    }\n\n    // TIER 3: Thumbnail endpoint with max size\n    try {\n        const thumbUrl = `https://drive.google.com/thumbnail?id=${fileId}\u0026sz=w4000`;\n        const response = await fetch(thumbUrl);\n        if (response.ok) {\n            const buffer = Buffer.from(await response.arrayBuffer());\n            // Validate it's actually an image\n            if (buffer[0] === 0xFF \u0026\u0026 buffer[1] === 0xD8) { // JPEG magic\n                return { \n                    bytes: buffer, \n                    method: 'thumbnail', \n                    tier: 3,\n                    isPreview: true  // Mark as potentially lower quality\n                };\n            }\n        }\n    } catch (e) {\n        console.error('[giil] Thumbnail download failed:', e.message);\n    }\n\n    // TIER 4: Playwright screenshot of image element\n    const imgElement = await page.$('img[src*=\"googleusercontent\"]');\n    if (imgElement) {\n        const buffer = await imgElement.screenshot({ type: 'png' });\n        return { bytes: buffer, method: 'element-screenshot', tier: 4 };\n    }\n\n    // TIER 5: Viewport screenshot (last resort)\n    const buffer = await page.screenshot({ type: 'png' });\n    return { bytes: buffer, method: 'viewport-screenshot', tier: 5 };\n}\n```\n\n## Large File Handling (\u003e100MB)\n\nGoogle shows a virus scan warning for large files. We need to handle this:\n\n```javascript\n// Check for virus scan warning and click through\nconst virusWarning = await page.$('form#download-form');\nif (virusWarning) {\n    console.error('[giil] Large file detected, attempting virus scan bypass...');\n    const confirmBtn = await page.$('a[href*=\"confirm=\"]');\n    if (confirmBtn) {\n        const downloadPromise = page.waitForEvent('download', { timeout: 30000 });\n        await confirmBtn.click();\n        const download = await downloadPromise;\n        // ... handle download\n    }\n}\n```\n\n## Quality Warning\n\nIf using tier 3 (thumbnail) or higher, output a warning:\n\n```javascript\nif (result.tier \u003e= 3) {\n    console.error('[giil] Warning: Using fallback method. Image may not be full resolution.');\n}\n```\n\n## Success Criteria\n\n- [ ] Download button works when visible\n- [ ] Direct URL works for simple files\n- [ ] Thumbnail fallback captures viewable content\n- [ ] Screenshot fallback always succeeds\n- [ ] Large file virus scan handled\n- [ ] Quality warning shown for fallback methods\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T22:41:18.866057831-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:41:18.866057831-05:00","dependencies":[{"issue_id":"get_icloud_image_link-hdm.4.3","depends_on_id":"get_icloud_image_link-hdm.4","type":"parent-child","created_at":"2026-01-03T22:41:18.896743493-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.4.3","depends_on_id":"get_icloud_image_link-hdm.4.2","type":"blocks","created_at":"2026-01-03T22:41:26.964412869-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.5","title":"EPIC: Phase 5 - Output \u0026 Error Handling","description":"## Overview\n\nStandardize output formats and error handling across all platforms for v3.\n\n## Key Changes\n\n### 1. JSON Schema v1\nAdd `schema_version`, `ok`, and `platform` fields for programmatic consumers.\n\n```json\n{\n  \"schema_version\": \"1\",\n  \"ok\": true,\n  \"platform\": \"dropbox\",\n  \"path\": \"/path/to/image.jpg\",\n  \"method\": \"direct\",\n  \"datetime\": \"2026-01-03T14:32:45.000Z\",\n  \"size\": 245678,\n  \"width\": 4032,\n  \"height\": 3024\n}\n```\n\n### 2. Error JSON Schema\n```json\n{\n  \"schema_version\": \"1\",\n  \"ok\": false,\n  \"platform\": \"gdrive\",\n  \"error\": {\n    \"code\": \"AUTH_REQUIRED\",\n    \"message\": \"File is not publicly shared.\",\n    \"remediation\": \"The owner must set sharing to 'Anyone with the link'.\"\n  }\n}\n```\n\n### 3. v3 Default Behavior Change\n- **v2**: MozJPEG compression by default\n- **v3**: Preserve original bytes by default\n- Add `--convert` and `--optimize` flags for opt-in processing\n\n### 4. New CLI Flags\n- `--print-url`: Output resolved direct URL (useful for debugging)\n- `--verbose`: Show detailed error messages with remediation steps\n- `--trace`: Enable Playwright tracing for debugging\n- `--debug-dir PATH`: Specify location for debug artifacts\n\n## Why This Matters\n\n1. **Scripting**: Structured output enables programmatic parsing\n2. **Debugging**: Better errors reduce support burden\n3. **Quality**: Preserving original bytes prevents silent degradation\n4. **Forward Compatibility**: Schema versioning allows safe evolution\n\n## Success Criteria\n\n- [ ] All JSON output includes schema_version, ok, platform\n- [ ] Error responses use consistent JSON structure\n- [ ] --print-url works for all platforms with direct URLs\n- [ ] Original bytes preserved by default (no lossy processing)\n","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-03T22:24:59.470791917-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:24:59.470791917-05:00","dependencies":[{"issue_id":"get_icloud_image_link-hdm.5","depends_on_id":"get_icloud_image_link-hdm","type":"parent-child","created_at":"2026-01-03T22:24:59.500110404-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.5","depends_on_id":"get_icloud_image_link-hdm.1","type":"blocks","created_at":"2026-01-03T22:27:23.871196079-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.5.1","title":"Implement v3 JSON schema with schema_version","description":"## What\n\nAdd `schema_version`, `ok`, and `platform` fields to all JSON output for programmatic consumers.\n\n## Why Schema Versioning\n\nAdding new fields is technically a breaking change for strict JSON parsers. The `schema_version` field allows consumers to:\n1. Detect schema version and handle accordingly\n2. Fail gracefully if schema is newer than expected\n3. Future-proof their integrations\n\n## Success Response\n\n```json\n{\n  \"schema_version\": \"1\",\n  \"ok\": true,\n  \"platform\": \"icloud\",\n  \"path\": \"/path/to/icloud_20260103_142245.jpg\",\n  \"method\": \"download\",\n  \"datetime\": \"2026-01-03T14:22:45.000Z\",\n  \"sourceUrl\": \"https://cvws.icloud-content.com/...\",\n  \"size\": 245678,\n  \"width\": 4032,\n  \"height\": 3024\n}\n```\n\n## Error Response\n\n```json\n{\n  \"schema_version\": \"1\",\n  \"ok\": false,\n  \"platform\": \"gdrive\",\n  \"error\": {\n    \"code\": \"AUTH_REQUIRED\",\n    \"message\": \"File is not publicly shared.\",\n    \"remediation\": \"The owner must set sharing to 'Anyone with the link'.\"\n  }\n}\n```\n\n## Album Mode (JSONL)\n\nEach photo outputs a separate JSON line:\n```json\n{\"schema_version\": \"1\", \"ok\": true, \"platform\": \"gphotos\", \"item_index\": 1, ...}\n{\"schema_version\": \"1\", \"ok\": true, \"platform\": \"gphotos\", \"item_index\": 2, ...}\n{\"schema_version\": \"1\", \"ok\": false, \"platform\": \"gphotos\", \"item_index\": 3, \"error\": {...}}\n```\n\n## Error Codes\n\n| Code | Exit | When |\n|------|------|------|\n| CAPTURE_FAILURE | 1 | All strategies failed |\n| USAGE_ERROR | 2 | Bad CLI options |\n| NETWORK_ERROR | 10 | Timeout, DNS failure |\n| AUTH_REQUIRED | 11 | Login redirect, password |\n| NOT_FOUND | 12 | Expired, deleted |\n| UNSUPPORTED_TYPE | 13 | Video, Google Doc |\n| INTERNAL_ERROR | 20 | Bug in giil |\n\n## Implementation\n\n```javascript\nfunction formatOutput(result, options) {\n    const base = {\n        schema_version: '1',\n        ok: !result.error,\n        platform: result.platform\n    };\n\n    if (result.error) {\n        return {\n            ...base,\n            error: {\n                code: result.error.code,\n                message: result.error.message,\n                remediation: result.error.remediation\n            }\n        };\n    }\n\n    return {\n        ...base,\n        path: result.path,\n        method: result.method,\n        datetime: result.datetime,\n        sourceUrl: result.sourceUrl,\n        size: result.size,\n        width: result.width,\n        height: result.height\n    };\n}\n```\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T22:25:19.449275085-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:57:13.642297396-05:00","closed_at":"2026-01-03T22:57:13.642297396-05:00","close_reason":"Implemented v3 JSON schema with formatJsonSuccess() and formatJsonError() helper functions. Added schema_version, ok, platform fields to all JSON output. Added error JSON output with code, message, remediation. Added detectPlatform() for multi-platform support. Added item_index for album mode.","dependencies":[{"issue_id":"get_icloud_image_link-hdm.5.1","depends_on_id":"get_icloud_image_link-hdm.5","type":"parent-child","created_at":"2026-01-03T22:25:19.477627263-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.5.2","title":"Change default to preserve original bytes (v3 behavior)","description":"## What\n\nChange v3 default behavior from MozJPEG compression to preserving original bytes.\n\n## Why This Change\n\n1. **Quality preservation**: UI screenshots shouldn't be recompressed\n2. **Performance**: Skip unnecessary processing when not needed\n3. **User expectations**: \"Download image\" should mean original image\n4. **Opt-in processing**: Users who want compression can request it\n\n## v2 Behavior (Current)\n```bash\n# Always processes through Sharp + MozJPEG\ngiil \"https://...\" \n# Output: Recompressed JPEG at quality 85\n```\n\n## v3 Behavior (New)\n```bash\n# Preserve original bytes by default\ngiil \"https://...\"\n# Output: Original file (JPEG/PNG/HEIC as received)\n\n# Opt-in to compression\ngiil \"https://...\" --optimize\n# Output: MozJPEG-optimized JPEG\n\n# Opt-in to format conversion\ngiil \"https://...\" --convert jpeg\n# Output: Converted to JPEG (from HEIC/PNG)\n```\n\n## New Flags\n\n| Flag | Description |\n|------|-------------|\n| `--optimize` | Apply MozJPEG optimization |\n| `--convert FORMAT` | Convert to format (jpeg, png, webp) |\n| `--quality N` | JPEG quality (only with --optimize or --convert) |\n\n## Implementation Changes\n\n```javascript\nasync function processImage(buffer, options) {\n    // v3: Only process if explicitly requested\n    if (!options.optimize \u0026\u0026 !options.convert) {\n        return buffer;  // Return original bytes\n    }\n\n    // Apply Sharp processing only when requested\n    let pipeline = sharp(buffer);\n    \n    if (options.convert === 'jpeg' || options.optimize) {\n        pipeline = pipeline.jpeg({\n            quality: options.quality || 85,\n            mozjpeg: options.optimize === true\n        });\n    }\n    // ... handle other formats\n    \n    return pipeline.toBuffer();\n}\n```\n\n## Migration Notes\n\nUsers relying on automatic compression must add `--optimize`:\n```bash\n# v2 equivalent in v3\ngiil \"https://...\" --optimize --quality 85\n```\n","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-01-03T22:25:36.616677708-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:58:44.494220699-05:00","dependencies":[{"issue_id":"get_icloud_image_link-hdm.5.2","depends_on_id":"get_icloud_image_link-hdm.5","type":"parent-child","created_at":"2026-01-03T22:25:36.646753573-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.5.2","depends_on_id":"get_icloud_image_link-hdm.5.1","type":"blocks","created_at":"2026-01-03T22:27:34.299907928-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.5.3","title":"Add debugging CLI flags (--print-url, --verbose, --trace)","description":"## What\n\nAdd debugging-focused CLI flags to help users troubleshoot issues.\n\n## New Flags\n\n### --print-url\nOutput the resolved direct URL instead of downloading.\n\n```bash\n$ giil \"https://www.dropbox.com/s/xxx/photo.png?dl=0\" --print-url\nhttps://www.dropbox.com/s/xxx/photo.png?raw=1\n\n$ giil \"https://photos.app.goo.gl/abc123\" --print-url\nhttps://lh3.googleusercontent.com/pw/xxx=s0\n```\n\n**Use cases:**\n- Debugging: see what URL giil is actually hitting\n- Integration: pipe URL to other tools (curl, wget)\n- Verification: confirm URL transformation is correct\n\n### --verbose\nShow detailed progress and error information.\n\n```bash\n$ giil \"https://...\" --verbose\n[giil] Detected platform: gphotos\n[giil] Launching Playwright (headless)\n[giil] Navigating to: https://photos.google.com/share/...\n[giil] Installing network interceptor\n[giil] Captured CDN URL: lh3.googleusercontent.com/pw/xxx=w1042-h862\n[giil] Extracting base URL: lh3.googleusercontent.com/pw/xxx\n[giil] Downloading full resolution with =s0 modifier\n[giil] Downloaded 2.14 MB\n[giil] Extracting EXIF datetime: 2026-01-03T14:22:45\n[giil] Saved to: gphotos_20260103_142245.jpg\n```\n\n### --trace\nEnable Playwright tracing for deep debugging.\n\n```bash\n$ giil \"https://...\" --trace\n[giil] Playwright tracing enabled\n[giil] Trace will be saved to: giil_trace_20260103_142245.zip\n# ... normal operation ...\n[giil] Trace saved: giil_trace_20260103_142245.zip\n[giil] View trace: npx playwright show-trace giil_trace_20260103_142245.zip\n```\n\n**What tracing captures:**\n- Screenshots at each action\n- DOM snapshots\n- Network requests/responses\n- Console logs\n\n### --debug-dir PATH\nSpecify where to save debug artifacts (default: current directory).\n\n```bash\n$ giil \"https://...\" --debug --debug-dir /tmp/giil-debug\n[giil] Debug artifacts will be saved to: /tmp/giil-debug/\n```\n\n## Implementation\n\n### Bash Layer\n```bash\nPRINT_URL=false\nVERBOSE=false\nTRACE=false\nDEBUG_DIR=\"\"\n\nwhile [[ $# -gt 0 ]]; do\n    case \"$1\" in\n        --print-url)  PRINT_URL=true; shift ;;\n        --verbose)    VERBOSE=true; shift ;;\n        --trace)      TRACE=true; shift ;;\n        --debug-dir)  DEBUG_DIR=\"$2\"; shift 2 ;;\n        # ... existing flags\n    esac\ndone\n```\n\n### JavaScript Layer\n```javascript\nconst verbose = process.argv.includes('--verbose');\nconst trace = process.argv.includes('--trace');\n\nfunction log(msg) {\n    if (verbose) console.error(`[giil] ${msg}`);\n}\n```\n\n## Interaction with Existing Flags\n\n| Flag Combo | Behavior |\n|------------|----------|\n| --print-url --json | URL in JSON format: `{\"url\": \"...\"}` |\n| --verbose --json | Verbose to stderr, JSON to stdout |\n| --debug --trace | Both artifacts saved |\n\n## Priority\n\nP3 - Nice to have for troubleshooting, not blocking for MVP.\n","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-03T22:42:01.671853476-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:42:01.671853476-05:00","dependencies":[{"issue_id":"get_icloud_image_link-hdm.5.3","depends_on_id":"get_icloud_image_link-hdm.5","type":"parent-child","created_at":"2026-01-03T22:42:01.700333566-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.6","title":"EPIC: Phase 6 - Testing Infrastructure","description":"## Overview\n\nBuild a comprehensive testing infrastructure with three layers: unit tests, replay tests, and live contract tests.\n\n## Why Three Layers\n\n| Layer | Speed | Reliability | Coverage |\n|-------|-------|-------------|----------|\n| Unit | Fast (\u003c1s) | 100% deterministic | Logic only |\n| Replay | Medium (1-5s) | 99% deterministic | Full flow, offline |\n| Live | Slow (10-60s) | Variable | Real platforms |\n\n## Layer 1: Unit Tests (Always in CI)\n\nTest pure functions without network or browser:\n- Platform detection (`detect_platform`, `detectPlatform`)\n- URL normalization (`normalize_dropbox_url`, etc.)\n- File ID extraction (`extractGoogleDriveFileId`)\n- Content validation (MIME types, magic bytes)\n- Output schema formatting\n\n```bash\n# Run unit tests\nnpm test -- --grep \"unit\"\n```\n\n## Layer 2: Replay Tests (Always in CI)\n\nUse recorded HAR fixtures to test full extraction flow:\n- Record network traffic from real sessions\n- Replay with Playwright's HAR feature\n- Deterministic, fast, works offline\n\n```bash\n# Record a fixture\nRECORD_HAR=1 giil \"https://...\" --output fixtures/\n\n# Run replay tests\nnpm test -- --grep \"replay\"\n```\n\n## Layer 3: Live Contract Tests (Scheduled/Optional)\n\nTest against real URLs to catch platform changes:\n- Gated behind `LIVE_TESTS=1` environment variable\n- Run nightly or on-demand\n- Accept occasional flakiness\n\n```bash\n# Run live tests\nLIVE_TESTS=1 npm test -- --grep \"live\"\n```\n\n## CI Configuration\n\n```yaml\njobs:\n  unit-tests:\n    runs-on: ubuntu-latest\n    steps:\n      - run: npm test -- --grep \"unit|replay\"\n\n  live-tests:\n    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'\n    runs-on: ubuntu-latest\n    steps:\n      - run: LIVE_TESTS=1 npm test -- --grep \"live\"\n```\n\n## Test URLs (For Live Tests)\n\nCreate dedicated public test shares for each platform:\n- Dropbox: Public folder with test images\n- Google Photos: Public album with test images\n- Google Drive: Public file with \"Anyone with link\"\n- iCloud: Existing test link\n\n## Success Criteria\n\n- [ ] Unit tests for all platform detection functions\n- [ ] Replay fixtures for each platform\n- [ ] Live tests with dedicated test shares\n- [ ] CI runs unit+replay on every PR\n- [ ] Nightly live test workflow\n","status":"open","priority":2,"issue_type":"epic","created_at":"2026-01-03T22:26:04.090006064-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:26:04.090006064-05:00","dependencies":[{"issue_id":"get_icloud_image_link-hdm.6","depends_on_id":"get_icloud_image_link-hdm","type":"parent-child","created_at":"2026-01-03T22:26:04.119687175-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.6","depends_on_id":"get_icloud_image_link-hdm.2","type":"blocks","created_at":"2026-01-03T22:27:23.888853924-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.6","depends_on_id":"get_icloud_image_link-hdm.3","type":"blocks","created_at":"2026-01-03T22:27:23.906448779-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.6","depends_on_id":"get_icloud_image_link-hdm.4","type":"blocks","created_at":"2026-01-03T22:27:23.923855121-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.6","depends_on_id":"get_icloud_image_link-hdm.5","type":"blocks","created_at":"2026-01-03T22:27:23.941216597-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.6.1","title":"Create unit test framework for pure functions","description":"## What\n\nSet up a unit test framework for testing pure functions without network or browser.\n\n## Scope\n\nTest these functions in isolation:\n- `detect_platform()` / `detectPlatform()` - Platform detection\n- `normalize_dropbox_url()` - URL normalization\n- `extractGoogleDriveFileId()` - File ID parsing\n- `validateContentType()` - MIME type validation\n- `validateMagicBytes()` - Binary header checking\n- `formatOutput()` - JSON schema formatting\n- `getUniqueFilename()` - Filename generation\n\n## Test Framework Choice\n\n**Option A: Node.js native test runner (recommended)**\n```bash\n# Node.js 18+ has built-in test runner\nnode --test tests/*.test.mjs\n```\n\nPros:\n- Zero dependencies\n- Fast startup\n- Native assertion library\n\n**Option B: Vitest/Jest**\nMore features but adds dependencies to a zero-dep tool.\n\n**Recommendation: Node.js native test runner**\n\n## Implementation\n\n### File Structure\n```\nscripts/\n└── tests/\n    ├── platform-detection.test.mjs\n    ├── url-normalization.test.mjs\n    ├── content-validation.test.mjs\n    └── output-formatting.test.mjs\n```\n\n### Example Test: Platform Detection\n```javascript\n// scripts/tests/platform-detection.test.mjs\nimport { describe, it } from 'node:test';\nimport assert from 'node:assert';\nimport { detectPlatform } from '../../extractor-functions.mjs';\n\ndescribe('detectPlatform', () =\u003e {\n    it('detects iCloud share URLs', () =\u003e {\n        assert.equal(detectPlatform('https://share.icloud.com/photos/abc123'), 'icloud');\n        assert.equal(detectPlatform('https://www.icloud.com/photos/#abc123'), 'icloud');\n    });\n\n    it('detects Dropbox URLs', () =\u003e {\n        assert.equal(detectPlatform('https://www.dropbox.com/scl/fi/xxx/photo.png?dl=0'), 'dropbox');\n        assert.equal(detectPlatform('https://www.dropbox.com/s/xxx/photo.png'), 'dropbox');\n    });\n\n    it('detects Google Photos URLs', () =\u003e {\n        assert.equal(detectPlatform('https://photos.app.goo.gl/abc123'), 'gphotos');\n        assert.equal(detectPlatform('https://photos.google.com/share/abc?key=xyz'), 'gphotos');\n    });\n\n    it('detects Google Drive URLs', () =\u003e {\n        assert.equal(detectPlatform('https://drive.google.com/file/d/xyz/view'), 'gdrive');\n        assert.equal(detectPlatform('https://drive.google.com/open?id=xyz'), 'gdrive');\n    });\n\n    it('returns unknown for unsupported URLs', () =\u003e {\n        assert.equal(detectPlatform('https://example.com/photo.jpg'), 'unknown');\n    });\n});\n```\n\n### Bash Function Testing\n\nExtract bash functions and test with bats or shell assertions:\n\n```bash\n# scripts/tests/test-bash-detection.sh\n#!/usr/bin/env bash\nsource \u003c(sed -n '/^detect_platform()/,/^}/p' ../../giil)\n\nassert_eq() {\n    [[ \"$1\" == \"$2\" ]] || { echo \"FAIL: expected '$2', got '$1'\"; exit 1; }\n}\n\nassert_eq \"$(detect_platform 'https://share.icloud.com/photos/abc')\" \"icloud\"\nassert_eq \"$(detect_platform 'https://www.dropbox.com/s/xxx/photo.png')\" \"dropbox\"\necho \"All bash tests passed\"\n```\n\n## CI Integration\n\n```yaml\n# .github/workflows/ci.yml\nunit-tests:\n  runs-on: ubuntu-latest\n  steps:\n    - uses: actions/checkout@v4\n    - uses: actions/setup-node@v4\n      with: { node-version: '20' }\n    - run: node --test scripts/tests/*.test.mjs\n    - run: bash scripts/tests/test-bash-detection.sh\n```\n\n## Test Extraction Challenge\n\nThe functions live inside the heredoc. Options:\n1. **Extract to separate file** - More modular but adds files\n2. **Inline test generation** - Test script extracts functions dynamically\n3. **E2E only** - Skip unit tests, rely on replay/live tests\n\n**Recommendation:** Option 2 - dynamically extract functions for testing without adding files to the distribution.\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T22:42:29.71965133-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:42:29.71965133-05:00","dependencies":[{"issue_id":"get_icloud_image_link-hdm.6.1","depends_on_id":"get_icloud_image_link-hdm.6","type":"parent-child","created_at":"2026-01-03T22:42:29.748872765-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.6.2","title":"Record HAR fixtures for replay tests","description":"## What\n\nRecord HTTP Archive (HAR) files from real sessions for deterministic replay testing.\n\n## Why HAR Replay\n\n- **Fast:** No network calls, runs in \u003c5 seconds\n- **Deterministic:** Same inputs → same outputs\n- **Offline:** CI doesn't need internet access\n- **Stable:** Immune to platform UI changes (uses recorded responses)\n\n## Playwright HAR Recording\n\n```javascript\n// Record a session\nconst context = await browser.newContext({\n    recordHar: { path: 'fixtures/dropbox.har' }\n});\n// ... perform actions ...\nawait context.close();  // HAR saved on close\n```\n\n## Replay in Tests\n\n```javascript\n// Replay from HAR\nconst context = await browser.newContext({\n    har: { path: 'fixtures/dropbox.har' }\n});\n// Network requests will be served from HAR\n```\n\n## Fixtures to Record\n\n| Platform | URL Type | Fixture Name |\n|----------|----------|--------------|\n| iCloud | Single photo | `icloud-single.har` |\n| iCloud | Album | `icloud-album.har` |\n| Dropbox | Single file | `dropbox-single.har` |\n| Google Photos | Single photo | `gphotos-single.har` |\n| Google Photos | Album | `gphotos-album.har` |\n| Google Drive | Public file | `gdrive-public.har` |\n\n## Recording Workflow\n\n```bash\n# 1. Set up recording environment\nexport RECORD_HAR=1\n\n# 2. Run giil against real URLs\n./giil \"https://share.icloud.com/photos/xxx\" --output /tmp/test\n\n# 3. HAR is saved to scripts/fixtures/\nls scripts/fixtures/*.har\n```\n\n## Implementation\n\nAdd to extractor.mjs:\n```javascript\nif (process.env.RECORD_HAR) {\n    const harPath = `fixtures/${detectPlatform(url)}-${Date.now()}.har`;\n    context = await browser.newContext({\n        recordHar: { path: harPath, mode: 'full' }\n    });\n    console.error(`[giil] Recording HAR to: ${harPath}`);\n}\n```\n\n## CI Configuration\n\n```yaml\nreplay-tests:\n  runs-on: ubuntu-latest\n  steps:\n    - uses: actions/checkout@v4\n    - run: npm ci\n    - run: npm test -- --grep \"replay\"\n```\n\n## Fixture Maintenance\n\nWhen platforms change their CDN/UI:\n1. Live tests will fail first (canary)\n2. Re-record fixtures: `RECORD_HAR=1 ./giil \"https://...\"`\n3. Update selectors/strategies if needed\n4. Commit new fixtures\n\n## Storage Considerations\n\nHAR files can be large (1-5MB each). Options:\n- Git LFS for large fixtures\n- Compress with gzip (Playwright supports .har.gz)\n- Store only essential responses (filter out analytics/ads)\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T22:42:53.176842524-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:42:53.176842524-05:00","dependencies":[{"issue_id":"get_icloud_image_link-hdm.6.2","depends_on_id":"get_icloud_image_link-hdm.6","type":"parent-child","created_at":"2026-01-03T22:42:53.205271008-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.6.2","depends_on_id":"get_icloud_image_link-hdm.6.1","type":"blocks","created_at":"2026-01-03T22:44:31.320607523-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.7","title":"EPIC: Phase 7 - Documentation \u0026 Release","description":"## Overview\n\nComprehensive documentation updates and v3.0.0 release preparation.\n\n## Documentation Updates\n\n### 1. Rebrand README\n```markdown\n\u003ch1\u003egiil\u003c/h1\u003e\n\u003ch3\u003eGet Image [from] Internet Link\u003c/h3\u003e\n\nOriginally built for iCloud, now supporting:\n- iCloud • Dropbox • Google Photos • Google Drive [experimental]\n```\n\n### 2. Platform Support Table\n```markdown\n| Platform | Method | Speed | Full Resolution |\n|----------|--------|-------|-----------------|\n| iCloud | Playwright (4-tier) | 5-15s | ✅ Yes |\n| Dropbox | Direct URL (no browser!) | 1-3s | ✅ Yes |\n| Google Photos | URL extraction + direct | 5-10s | ✅ Yes |\n| Google Drive | Playwright [experimental] | 5-15s | Conditional |\n```\n\n### 3. Per-Platform Examples\nShow usage for each platform with expected output.\n\n### 4. Per-Platform Troubleshooting\n- Dropbox: Password-protected, expired links\n- Google Photos: Private albums, video handling\n- Google Drive: \"Anyone with link\" requirement\n- iCloud: Existing troubleshooting (unchanged)\n\n### 5. Migration Notes\n```markdown\n## Upgrading from v2.x\n\nKey changes:\n- Default: Original bytes preserved (compression now opt-in)\n- New JSON fields: schema_version, ok, platform\n- New exit codes: 10-13, 20\n- New flags: --optimize, --convert, --print-url\n```\n\n## AGENTS.md Updates\n\n- Add new platform architecture to \"Supported Platforms\" section\n- Update capture strategy diagram\n- Document new exit codes\n\n## Release Checklist\n\n1. [ ] Update VERSION to 3.0.0\n2. [ ] Update README with all changes\n3. [ ] Update AGENTS.md\n4. [ ] Create release notes template\n5. [ ] Tag v3.0.0\n6. [ ] Verify GitHub release artifacts\n7. [ ] Update install.sh URL in README\n\n## Success Criteria\n\n- [ ] README reflects multi-platform support\n- [ ] Each platform has usage examples\n- [ ] Each platform has troubleshooting section\n- [ ] Migration notes help v2 users\n- [ ] v3.0.0 release published with checksums\n","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-03T22:26:24.290759855-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:26:24.290759855-05:00","dependencies":[{"issue_id":"get_icloud_image_link-hdm.7","depends_on_id":"get_icloud_image_link-hdm","type":"parent-child","created_at":"2026-01-03T22:26:24.320086429-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.7","depends_on_id":"get_icloud_image_link-hdm.6","type":"blocks","created_at":"2026-01-03T22:27:23.958908937-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.7.1","title":"Rewrite README for multi-platform support","description":"## What\n\nComprehensively update README.md to reflect multi-platform support, rebrand messaging, and v3 changes.\n\n## Header Rebrand\n\nFROM:\n```markdown\n# Get iCloud Image Link\nDownload full-resolution images from iCloud photo shares\n```\n\nTO:\n```markdown\n# giil\n### Get Image [from] Internet Link\n\nDownload full-resolution images from cloud sharing links.\nOriginally built for iCloud, now supporting Dropbox, Google Photos, and Google Drive.\n```\n\n## New Platform Support Table\n\n```markdown\n## Supported Platforms\n\n| Platform | Method | Speed | Full Resolution | Notes |\n|----------|--------|-------|-----------------|-------|\n| iCloud | Playwright (4-tier) | 5-15s | ✅ Always | Original and best-supported |\n| Dropbox | Direct URL | 1-3s | ✅ Always | No browser needed! |\n| Google Photos | URL extraction | 5-10s | ✅ Always | Uses =s0 modifier |\n| Google Drive | Playwright | 5-15s | Conditional | [Experimental] Requires public sharing |\n```\n\n## Per-Platform Examples\n\n```markdown\n## Quick Examples\n\n### iCloud\n\\`\\`\\`bash\ngiil \"https://share.icloud.com/photos/abc123\"\n\\`\\`\\`\n\n### Dropbox (fastest!)\n\\`\\`\\`bash\ngiil \"https://www.dropbox.com/scl/fi/xxx/photo.png?dl=0\"\n# Direct download, no browser needed\n\\`\\`\\`\n\n### Google Photos\n\\`\\`\\`bash\ngiil \"https://photos.app.goo.gl/abc123\"\n# Also works with album links for --all mode\n\\`\\`\\`\n\n### Google Drive [experimental]\n\\`\\`\\`bash\ngiil \"https://drive.google.com/file/d/xxx/view\"\n# File must be shared as \"Anyone with the link\"\n\\`\\`\\`\n```\n\n## Per-Platform Troubleshooting\n\n```markdown\n## Troubleshooting\n\n### Dropbox\n- **\"Received HTML instead of image\"**: Link may be password-protected or expired\n- **Empty output**: Verify the file is publicly shared\n\n### Google Photos  \n- **\"AUTH_REQUIRED\"**: Album is private. Ask owner to make it public.\n- **Low resolution**: Ensure giil is using =s0 modifier (check with --verbose)\n\n### Google Drive\n- **\"File is not publicly shared\"**: Owner must set \"Anyone with the link\" access\n- **Quality warning**: Drive may return lower-resolution thumbnails as fallback\n```\n\n## v3 Changes Section\n\n```markdown\n## Upgrading from v2.x\n\n### Breaking Changes\n- **Exit codes 4 and 5 changed**: Network errors now exit 10, auth errors exit 11\n- **JSON schema additions**: New fields `schema_version`, `ok`, `platform`\n\n### Behavior Changes\n- **Original bytes preserved by default**: Use `--optimize` for MozJPEG compression\n- **New flags**: `--print-url`, `--verbose`, `--trace`, `--convert`, `--optimize`\n\n### Migration\n\\`\\`\\`bash\n# If you were checking exit codes:\n# v2: if [ $? -eq 4 ]; then  →  v3: if [ $? -eq 10 ]; then\n# v2: if [ $? -eq 5 ]; then  →  v3: if [ $? -eq 11 ]; then\n\n# If you relied on automatic JPEG compression:\n# v2: giil \"https://...\"\n# v3: giil \"https://...\" --optimize\n\\`\\`\\`\n```\n\n## File Size Considerations\n\nCurrent README is comprehensive. Be careful not to bloat it. Consider:\n- Keep main README focused on quick-start\n- Add PLATFORMS.md for deep platform-specific docs (if needed)\n- Link to GitHub wiki for edge cases\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-03T22:43:21.07736515-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:43:21.07736515-05:00","dependencies":[{"issue_id":"get_icloud_image_link-hdm.7.1","depends_on_id":"get_icloud_image_link-hdm.7","type":"parent-child","created_at":"2026-01-03T22:43:21.106462934-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.7.1","depends_on_id":"get_icloud_image_link-hdm.5.1","type":"blocks","created_at":"2026-01-03T22:44:31.340184091-05:00","created_by":"ubuntu"}]}
{"id":"get_icloud_image_link-hdm.7.2","title":"Update AGENTS.md architecture diagram","description":"## What\n\nUpdate the architecture diagram in AGENTS.md to reflect v3 changes, specifically the Dropbox fast path that bypasses extractor.mjs.\n\n## Current Diagram (INCORRECT for v3)\n\n```\n        ┌─────────┐          ┌──────────┐          ┌──────────┐\n        │ Dropbox │          │  Google  │          │  iCloud/ │\n        │ (curl)  │          │  Photos  │          │  GDrive  │\n        └─────────┘          └──────────┘          └──────────┘\n             │                     │                     │\n             ▼                     ▼                     ▼\n        ┌─────────────────────────────────────────────────────────┐\n        │              extractor.mjs (Playwright)                  │\n```\n\nThis shows Dropbox going to extractor.mjs, but v3 bypasses it entirely!\n\n## Corrected Diagram (v3)\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                    URL Input                                     │\n└─────────────────────────────────────────────────────────────────┘\n                              │\n                              ▼\n                    ┌──────────────────┐\n                    │ detect_platform()│\n                    └──────────────────┘\n                              │\n        ┌─────────────────────┼─────────────────────┐\n        ▼                     ▼                     ▼\n   ┌─────────┐          ┌──────────┐          ┌──────────┐\n   │ Dropbox │          │  Google  │          │  iCloud/ │\n   │ FAST    │          │  Photos  │          │  GDrive  │\n   └─────────┘          └──────────┘          └──────────┘\n        │                     │                     │\n        │                     ▼                     ▼\n        │            ┌─────────────────────────────────────────┐\n        │            │        extractor.mjs (Playwright)        │\n        │            │                                           │\n        │            │   TIER 1: Download button (9 selectors)   │\n        │            │      ↓ fail                               │\n        │            │   TIER 2: Network CDN interception        │\n        │            │      ↓ fail                               │\n        │            │   TIER 3: Element screenshot              │\n        │            │      ↓ fail                               │\n        │            │   TIER 4: Viewport screenshot             │\n        │            └─────────────────────────────────────────┘\n        │                           │\n        ▼                           ▼\n   ┌─────────┐            ┌──────────────────┐\n   │  curl   │            │ Image Processing │\n   │ raw=1   │            │  Sharp + MozJPEG │\n   └─────────┘            │  EXIF extraction │\n        │                 │  HEIC conversion │\n        │                 └──────────────────┘\n        │                           │\n        └───────────────┬───────────┘\n                        ▼\n              ┌──────────────────┐\n              │     Output       │\n              │ (file/json/b64)  │\n              └──────────────────┘\n```\n\n## Key Changes to Highlight\n\n1. **Dropbox exits early** - Direct curl download, no Playwright\n2. **Platform-specific paths** - Each platform has tailored strategy\n3. **Shared output layer** - All paths converge for final output\n\n## Also Update\n\n1. Exit codes table (add new codes 10-13, 20)\n2. CLI options table (add new flags)\n3. Supported Platforms table (already present, verify accuracy)\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T22:43:47.488767143-05:00","created_by":"ubuntu","updated_at":"2026-01-03T22:43:47.488767143-05:00","dependencies":[{"issue_id":"get_icloud_image_link-hdm.7.2","depends_on_id":"get_icloud_image_link-hdm.7","type":"parent-child","created_at":"2026-01-03T22:43:47.518067719-05:00","created_by":"ubuntu"},{"issue_id":"get_icloud_image_link-hdm.7.2","depends_on_id":"get_icloud_image_link-hdm.7.1","type":"blocks","created_at":"2026-01-03T22:44:31.360643281-05:00","created_by":"ubuntu"}]}
